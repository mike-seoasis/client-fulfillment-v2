{
  "name": "POP API Integration",
  "description": "Replace homegrown ContentScoreService with PageOptimizer Pro (POP) API integration for SERP-based content scoring. Adds two new phases: Content Brief (fetch targets before writing) and Content Scoring (score generated content).",
  "branchName": "feature/replace-content-scoring-api",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add POP API configuration",
      "description": "As a developer, I need POP API configuration settings so that the integration can connect to the PageOptimizer Pro service.",
      "acceptanceCriteria": [
        "Add pop_api_key, pop_api_url, pop_task_poll_interval, pop_task_timeout to app/core/config.py",
        "Add pop_circuit_failure_threshold and pop_circuit_recovery_timeout settings",
        "Add POP_API_KEY to .env.example with documentation comment",
        "All settings use pydantic Field() with descriptions"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Reference existing dataforseo settings pattern in config.py",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-002",
      "title": "Create database migrations",
      "description": "As a developer, I need database tables to store content briefs and POP scores so that data persists across sessions.",
      "acceptanceCriteria": [
        "Create alembic migration for content_briefs table with columns: id, page_id, keyword, pop_task_id, word_count_target, word_count_min, word_count_max, heading_targets (JSON), keyword_targets (JSON), lsi_terms (JSON), entities (JSON), related_questions (JSON), related_searches (JSON), competitors (JSON), page_score_target, raw_response (JSON), created_at, updated_at",
        "Create alembic migration for content_scores table with columns: id, page_id, pop_task_id, page_score, passed, keyword_analysis (JSON), lsi_coverage (JSON), word_count_current, heading_analysis (JSON), recommendations (JSON), fallback_used, raw_response (JSON), scored_at, created_at",
        "Add foreign key constraints to crawled_pages table",
        "Migrations run successfully with alembic upgrade head"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Follow existing migration patterns in alembic/versions/",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-003",
      "title": "Create POP integration client base",
      "description": "As a developer, I need a POP API client so that services can communicate with PageOptimizer Pro.",
      "acceptanceCriteria": [
        "Create app/integrations/pop.py with POPClient class",
        "Use httpx async client matching dataforseo.py pattern",
        "Implement auth handling with apiKey in request body",
        "Add factory function get_pop_client() for dependency injection",
        "Client is importable and instantiable"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Follow app/integrations/dataforseo.py pattern exactly",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-004",
      "title": "Implement POP task creation and polling",
      "description": "As a developer, I need methods to create POP tasks and poll for results so that async API operations complete successfully.",
      "acceptanceCriteria": [
        "Implement create_report_task() method that POSTs to POP API with keyword/URL",
        "Implement get_task_result() method that GETs task status/results",
        "Implement polling loop with configurable interval (default 3s) and timeout (default 300s)",
        "Polling stops when task status is SUCCESS or FAILURE",
        "Timeout raises POPTimeoutError with task_id and elapsed time"
      ],
      "priority": 1,
      "passes": true,
      "notes": "POP API endpoint: https://app.pageoptimizer.pro/api/task/:task_id/results/",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-005",
      "title": "Implement circuit breaker for POP client",
      "description": "As a developer, I need a circuit breaker so that POP API failures don't cascade and the system degrades gracefully.",
      "acceptanceCriteria": [
        "Implement CircuitBreaker class with CLOSED, OPEN, HALF_OPEN states",
        "Circuit opens after failure_threshold consecutive failures (default 5)",
        "Circuit recovers after recovery_timeout seconds (default 60)",
        "Half-open state allows one test request through",
        "Successful test closes circuit, failure reopens it"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Copy pattern from dataforseo.py CircuitBreaker class",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-006",
      "title": "Implement retry logic for POP client",
      "description": "As a developer, I need retry logic so that transient API errors are handled automatically.",
      "acceptanceCriteria": [
        "Implement exponential backoff retry for transient errors (5xx, timeouts)",
        "Do not retry auth errors (401, 403) or client errors (4xx except 429)",
        "Retry rate limit errors (429) with Retry-After header if present",
        "Max retries configurable (default 3)",
        "Each retry logs attempt number"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-007",
      "title": "Implement POP client logging",
      "description": "As a developer, I need comprehensive logging in the POP client so that API interactions are traceable and debuggable.",
      "acceptanceCriteria": [
        "Log all outbound API calls with endpoint, method, and timing at INFO level",
        "Log request/response bodies at DEBUG level, truncating responses >5KB",
        "Implement credential masking - apiKey must NEVER appear in logs",
        "Log timeout errors with task_id, elapsed time, and configured timeout",
        "Log rate limit errors (429) with retry-after header if present",
        "Log auth failures (401/403) without exposing credentials",
        "Include retry attempt number in all retry-related logs",
        "Log API cost/credits used per request if POP provides this",
        "Log circuit breaker state changes at WARNING level",
        "Log poll attempts with task_id, attempt number, and current status"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Credential masking is critical - verify with unit tests",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-008",
      "title": "Write POP client unit tests",
      "description": "As a developer, I need unit tests for the POP client so that the integration is reliable and regressions are caught.",
      "acceptanceCriteria": [
        "Tests for create_report_task() with mocked successful response",
        "Tests for get_task_result() with mocked pending and complete responses",
        "Tests for polling loop timeout behavior",
        "Tests for circuit breaker state transitions",
        "Tests for retry logic with various error codes",
        "Tests verifying credential masking in logs (capture log output, assert no apiKey)",
        "All tests pass with pytest"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Use pytest-httpx for mocking",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-009",
      "title": "Create database models",
      "description": "As a developer, I need SQLAlchemy models for content briefs and scores so that data can be persisted and queried.",
      "acceptanceCriteria": [
        "Create ContentBrief model in app/models/content_brief.py with all table columns",
        "Create ContentScore model in app/models/content_score.py with all table columns",
        "Add relationship to CrawledPage model (page.content_briefs, page.content_scores)",
        "Models are importable from app.models",
        "JSON columns use SQLAlchemy JSON type"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Follow existing model patterns in app/models/",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-010",
      "title": "Create Pydantic schemas",
      "description": "As a developer, I need Pydantic schemas for API request/response validation so that data is properly typed.",
      "acceptanceCriteria": [
        "Create app/schemas/content_brief.py with ContentBriefRequest, ContentBriefResponse schemas",
        "Create app/schemas/content_score.py with ContentScoreRequest, ContentScoreResponse schemas",
        "Include nested schemas for complex fields (LSI terms, competitors, recommendations)",
        "Schemas validate required fields and types",
        "Response schemas include all fields from database models"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-011",
      "title": "Create Content Brief service structure",
      "description": "As a developer, I need a POPContentBriefService so that content briefs can be fetched and stored.",
      "acceptanceCriteria": [
        "Create app/services/pop_content_brief.py with POPContentBriefService class",
        "Include ERROR LOGGING REQUIREMENTS docstring matching project standard",
        "Service accepts POP client via dependency injection",
        "Implement fetch_brief(project_id, page_id, keyword, target_url) method signature",
        "Return POPContentBriefResult dataclass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Follow app/services/paa_enrichment.py pattern",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-012",
      "title": "Implement content brief data extraction",
      "description": "As a developer, I need to extract structured data from POP API responses so that content targets are usable.",
      "acceptanceCriteria": [
        "Extract word count targets (min, max, target) from POP response",
        "Extract heading structure targets (H1-H4 min/max counts) from tagCounts",
        "Extract keyword density targets by section (title, H1, H2, H3, paragraph) from cleanedContentBrief",
        "Extract LSI terms with phrase, weight, averageCount, targetCount from lsaPhrases",
        "Extract related questions (PAA) from relatedQuestions array",
        "Extract competitor data (url, title, pageScore) from competitors array",
        "Handle missing fields gracefully with defaults"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Reference POP API docs at /Users/mike/Downloads/PageOptimizer_Pro_API_Documentation.md",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-013",
      "title": "Implement content brief persistence",
      "description": "As a developer, I need to save content briefs to the database so that they're available for content generation.",
      "acceptanceCriteria": [
        "Save brief to content_briefs table after successful fetch",
        "Link brief to page via page_id foreign key",
        "Store pop_task_id for reference/debugging",
        "Store structured fields (word_count_*, heading_targets, etc.)",
        "Store raw_response JSON for debugging",
        "Replace existing brief if one exists for the same page"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-014",
      "title": "Implement content brief service logging",
      "description": "As a developer, I need comprehensive logging in the content brief service so that operations are traceable.",
      "acceptanceCriteria": [
        "Log method entry at DEBUG level with parameters (project_id, page_id, keyword - sanitized)",
        "Log method exit at DEBUG level with result summary (success/failure, brief_id)",
        "Log all exceptions with full stack trace, project_id, page_id, and context",
        "Include entity IDs (project_id, page_id, brief_id) in ALL log messages",
        "Log validation failures with field name and rejected value",
        "Log phase state transitions at INFO level (brief_fetch_started, brief_fetch_completed)",
        "Add timing logs for operations >1 second (SLOW_OPERATION_THRESHOLD_MS = 1000)",
        "Log brief extraction stats at INFO level (word_count_target, lsi_term_count, competitor_count)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-015",
      "title": "Write content brief service tests",
      "description": "As a developer, I need unit tests for the content brief service so that extraction and persistence are reliable.",
      "acceptanceCriteria": [
        "Tests for fetch_brief() with mocked POP client",
        "Tests for each extraction method (word count, headings, keywords, LSI, PAA, competitors)",
        "Tests for database persistence",
        "Tests for error handling (POP failure, timeout, parse errors)",
        "Tests verifying logging output includes required entity IDs",
        "All tests pass with pytest"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-016",
      "title": "Create Content Scoring service structure",
      "description": "As a developer, I need a POPContentScoreService so that generated content can be scored.",
      "acceptanceCriteria": [
        "Create app/services/pop_content_score.py with POPContentScoreService class",
        "Include ERROR LOGGING REQUIREMENTS docstring matching project standard",
        "Service accepts POP client via dependency injection",
        "Implement score_content(project_id, page_id, keyword, content_url) method signature",
        "Return POPContentScoreResult dataclass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-017",
      "title": "Implement content scoring data extraction",
      "description": "As a developer, I need to extract scoring data from POP API responses so that content quality is measurable.",
      "acceptanceCriteria": [
        "Extract page score (0-100) from pageScore/pageScoreValue",
        "Extract keyword density analysis (current vs target per section) from cleanedContentBrief",
        "Extract LSI term coverage (phrase, current_count, target_count, weight)",
        "Extract word count comparison (current vs target)",
        "Extract heading structure analysis (current vs min/max per level) from tagCounts",
        "Extract recommendations from custom recommendations endpoint",
        "Handle missing fields gracefully"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-018",
      "title": "Implement pass/fail determination",
      "description": "As a developer, I need to determine if content passes the scoring threshold so that quality is gated.",
      "acceptanceCriteria": [
        "Content passes if page_score >= 70",
        "Response includes passed: true/false boolean",
        "Response includes prioritized recommendations when failed",
        "Threshold is configurable via settings"
      ],
      "priority": 1,
      "passes": true,
      "notes": "70 is initial threshold - may need calibration",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-019",
      "title": "Implement fallback to legacy scoring",
      "description": "As a developer, I need fallback to ContentScoreService when POP is unavailable so that scoring doesn't block the workflow.",
      "acceptanceCriteria": [
        "Fallback triggers when POP circuit breaker is open",
        "Fallback triggers on POP API errors (after retries exhausted)",
        "Fallback triggers on POP timeout",
        "Response includes fallback: true flag when fallback used",
        "Fallback events logged at WARNING level with reason"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Legacy service: app/services/content_score.py ContentScoreService",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-020",
      "title": "Implement content score persistence",
      "description": "As a developer, I need to save content scores to the database so that scoring history is tracked.",
      "acceptanceCriteria": [
        "Save score to content_scores table after successful scoring",
        "Link score to page via page_id foreign key",
        "Store pop_task_id, page_score, passed, fallback_used",
        "Store analysis JSON fields (keyword, lsi, heading, recommendations)",
        "Store raw_response JSON for debugging",
        "Store scored_at timestamp"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-021",
      "title": "Implement batch scoring support",
      "description": "As a developer, I need to score multiple content pieces in one request so that batch operations are efficient.",
      "acceptanceCriteria": [
        "Implement score_batch(items) method accepting list of (page_id, keyword, url)",
        "Create POP tasks for each item respecting rate limits",
        "Return results as they complete (don't wait for all)",
        "Include individual success/failure status per item",
        "Handle partial failures gracefully"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-022",
      "title": "Implement content scoring service logging",
      "description": "As a developer, I need comprehensive logging in the scoring service so that operations are traceable.",
      "acceptanceCriteria": [
        "Log method entry at DEBUG level with parameters (project_id, page_id, content_url - sanitized)",
        "Log method exit at DEBUG level with result summary (score, passed, fallback_used)",
        "Log all exceptions with full stack trace, project_id, page_id, and context",
        "Include entity IDs (project_id, page_id, score_id) in ALL log messages",
        "Log validation failures with field name and rejected value",
        "Log phase state transitions at INFO level (scoring_started, scoring_completed)",
        "Add timing logs for operations >1 second",
        "Log fallback events at WARNING level with reason (circuit_open, api_error, timeout)",
        "Log scoring results at INFO level (page_score, passed, recommendation_count)",
        "Log API cost per scoring request for monitoring/alerting"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-023",
      "title": "Write content scoring service tests",
      "description": "As a developer, I need unit tests for the scoring service so that scoring and fallback are reliable.",
      "acceptanceCriteria": [
        "Tests for score_content() with mocked POP client",
        "Tests for each extraction method",
        "Tests for pass/fail determination at threshold boundary",
        "Tests for fallback triggering (circuit open, API error, timeout)",
        "Tests for batch scoring",
        "Tests verifying logging output includes required entity IDs",
        "All tests pass with pytest"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-024",
      "title": "Create content brief API endpoints",
      "description": "As a developer, I need API endpoints so that the frontend can trigger content brief fetching.",
      "acceptanceCriteria": [
        "Create app/api/v1/endpoints/content_brief.py",
        "Implement POST /projects/{project_id}/phases/content_brief/fetch endpoint",
        "Implement GET /projects/{project_id}/pages/{page_id}/brief endpoint",
        "Endpoints validate project/page existence",
        "Endpoints return proper error responses (404, 422, 500)",
        "Add request_id tracking to all endpoint logs"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-025",
      "title": "Create content scoring API endpoints",
      "description": "As a developer, I need API endpoints so that the frontend can trigger content scoring.",
      "acceptanceCriteria": [
        "Create app/api/v1/endpoints/pop_content_score.py",
        "Implement POST /projects/{project_id}/phases/content_score/score endpoint (single)",
        "Implement POST /projects/{project_id}/phases/content_score/batch endpoint",
        "Endpoints validate project/page existence",
        "Endpoints return proper error responses",
        "Add request_id tracking to all endpoint logs"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-026",
      "title": "Register new endpoints in router",
      "description": "As a developer, I need the new endpoints registered so that they're accessible via the API.",
      "acceptanceCriteria": [
        "Add content_brief router to app/api/v1/api.py",
        "Add pop_content_score router to app/api/v1/api.py",
        "Endpoints accessible at /api/v1/projects/{project_id}/phases/...",
        "OpenAPI docs show new endpoints"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-027",
      "title": "Add feature flags for POP integration",
      "description": "As a developer, I need feature flags so that POP integration can be enabled/disabled without code changes.",
      "acceptanceCriteria": [
        "Add use_pop_content_brief boolean setting to config",
        "Add use_pop_scoring boolean setting to config",
        "Defaults to False (disabled) for safe rollout",
        "Settings loadable from environment variables"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-028",
      "title": "Wire content brief into workflow",
      "description": "As a developer, I need the content brief phase wired into the content workflow so that briefs are fetched before content generation.",
      "acceptanceCriteria": [
        "Content generation phase checks use_pop_content_brief flag",
        "When enabled, fetches brief before calling content writer",
        "Brief data (word count targets, LSI terms, etc.) passed to content writer",
        "Content generation works normally when flag disabled",
        "Errors in brief fetch don't block content generation (log warning, proceed without brief)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Modify app/services/content_generation.py",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-029",
      "title": "Wire content scoring into workflow",
      "description": "As a developer, I need POP scoring wired into the content workflow so that generated content is scored.",
      "acceptanceCriteria": [
        "Content scoring phase checks use_pop_scoring flag",
        "When enabled, uses POPContentScoreService instead of ContentScoreService",
        "Fallback indicator included in scoring response",
        "Content scoring works normally when flag disabled (uses legacy service)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-030",
      "title": "Create integration tests",
      "description": "As a developer, I need integration tests so that the full flow is validated.",
      "acceptanceCriteria": [
        "Integration test for POP client against real API (skip in CI via pytest mark)",
        "End-to-end test for content brief -> generation -> scoring flow with mocks",
        "Tests run successfully with pytest"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Use @pytest.mark.skip_ci for real API tests",
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-031",
      "title": "Add shadow mode for scoring comparison",
      "description": "As a developer, I need shadow mode so that POP scoring can be compared to legacy scoring before cutover.",
      "acceptanceCriteria": [
        "When shadow mode enabled, run both POP and legacy scoring",
        "Log comparison metrics (score difference, pass/fail agreement)",
        "Shadow mode doesn't affect response (returns legacy result)",
        "Metrics logged for analysis"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Helps validate POP scoring before full cutover"
    },
    {
      "id": "US-032",
      "title": "Update documentation",
      "description": "As a developer, I need documentation updated so that the integration is understood and maintainable.",
      "acceptanceCriteria": [
        "Update API documentation with new endpoints",
        "Add POP integration section to project README",
        "Document fallback behavior and monitoring alerts",
        "Document log fields and levels for ops/monitoring team",
        "Mark ContentScoreService as deprecated in docstring (keep for fallback)"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    }
  ],
  "metadata": {
    "updatedAt": "2026-02-02T20:43:52.651Z"
  }
}