# Ralph Progress Log

This file tracks progress across iterations. Agents update this file
after each iteration and it's included in prompts for context.

## Codebase Patterns (Study These First)

### Phase Endpoint Pattern
Phase endpoints follow a consistent structure in `backend/app/api/v1/endpoints/`:
- Router registered with prefix `/projects/{project_id}/phases/{phase_name}`
- Helper `_get_request_id(request)` to extract request ID from state
- Helper `_verify_project_exists()` returning `JSONResponse | None` for 404 handling
- Structured error responses: `{"error": str, "code": str, "request_id": str}`
- Log levels: DEBUG for request body, INFO for completion, WARNING for 4xx, ERROR for 5xx
- All endpoints include `request_id`, `project_id` in log `extra` dict

### Request Logging Pattern
- Request ID generated by `RequestLoggingMiddleware` in `main.py`
- Available via `request.state.request_id`
- Always include in error responses and log extra data
- Timing tracked with `time.monotonic()` for duration_ms

### Frontend Error Logging Pattern
- Global handlers set up in `frontend/src/lib/globalErrorHandlers.ts` - call `setupGlobalErrorHandlers()` before React mounts
- Error reporting service integration in `frontend/src/lib/errorReporting.ts` - supports Sentry via `VITE_SENTRY_DSN`
- `ErrorBoundary` component wraps routes with `componentName` prop for context
- API client in `frontend/src/lib/api.ts` accepts `userAction` and `component` options for error context
- All API errors logged with: endpoint, method, status, responseBody, userAction, component

---

## 2026-02-01 - client-onboarding-v2-c3y.62
- **What was implemented**: Verified PAA enrichment endpoints already fully implemented
- **Files present** (no changes needed):
  - `backend/app/api/v1/endpoints/paa_enrichment.py` - Full endpoint implementation
  - `backend/app/schemas/paa_enrichment.py` - Pydantic request/response schemas
  - `backend/app/api/v1/__init__.py` - Router registration at `/projects/{project_id}/phases/paa_enrichment`
  - `backend/app/services/paa_enrichment.py` - Service layer for PAA operations
- **Endpoints available**:
  - `POST /api/v1/projects/{id}/phases/paa_enrichment/enrich` - Single keyword enrichment
  - `POST /api/v1/projects/{id}/phases/paa_enrichment/batch` - Batch enrichment
  - `GET /api/v1/projects/{id}/phases/paa_enrichment/stats` - Statistics
- **Quality checks**: Passed mypy typecheck and ruff lint
- **Learnings:**
  - Pattern: Phase endpoints already well-established, can reference brand_config.py or schedule.py as templates
  - Gotcha: mypy errors in other files (projects.py, logging.py, redis.py) are pre-existing - PAA files are clean
---

## 2026-02-01 - client-onboarding-v2-c3y.104
- **What was implemented**: Verified crawl-history endpoints already fully implemented
- **Files present** (no changes needed):
  - `backend/app/api/v1/endpoints/crawl.py` - Full endpoint implementation (873 lines)
  - `backend/app/schemas/crawl.py` - Pydantic request/response schemas
  - `backend/app/api/v1/__init__.py` - Router registration at `/projects/{project_id}/phases/crawl`
  - `backend/app/services/crawl.py` - Service layer for crawl operations
  - `backend/app/models/crawl_history.py` - CrawlHistory model
  - `backend/app/models/crawled_page.py` - CrawledPage model
- **Endpoints available**:
  - `POST /api/v1/projects/{id}/phases/crawl` - Start a new crawl (202 Accepted, runs in background)
  - `GET /api/v1/projects/{id}/phases/crawl` - List crawl history (paginated, filterable by status)
  - `GET /api/v1/projects/{id}/phases/crawl/{crawl_id}` - Get crawl details
  - `GET /api/v1/projects/{id}/phases/crawl/{crawl_id}/progress` - Get crawl progress
  - `POST /api/v1/projects/{id}/phases/crawl/{crawl_id}/stop` - Stop a running crawl
  - `GET /api/v1/projects/{id}/phases/crawl/pages` - List crawled pages (paginated, filterable by category)
  - `GET /api/v1/projects/{id}/phases/crawl/pages/{page_id}` - Get crawled page details
- **Quality checks**: Passed ruff lint; mypy errors are in pre-existing files only (logging.py, redis.py, projects.py)
- **Learnings:**
  - Pattern: Background crawl execution uses FastAPI BackgroundTasks with `_run_crawl_background()` helper
  - Pattern: Crawl supports filter query params with `alias` for cleaner API (`status_filter` â†’ `status`)
  - Pattern: Project verification is reusable across endpoints via `_verify_project_exists()` helper
  - Pattern: CrawlProgress aggregates data from history.stats dict plus error_log count
---

## 2026-02-01 - client-onboarding-v2-c3y.71
- **What was implemented**: Document upload endpoint with S3/local storage support
- **Files created**:
  - `backend/app/schemas/document.py` - Pydantic schemas for document upload/download/delete
  - `backend/app/services/storage.py` - Storage service with LocalStorageBackend and S3StorageBackend
  - `backend/app/api/v1/endpoints/documents.py` - REST endpoints for document operations
  - `backend/app/api/v1/__init__.py` - Router registration at `/projects/{project_id}/documents`
- **Endpoints available**:
  - `POST /api/v1/projects/{id}/documents/upload` - Upload a document (multipart/form-data)
  - `GET /api/v1/projects/{id}/documents/{document_id}/download` - Download a document
  - `DELETE /api/v1/projects/{id}/documents/{document_id}` - Delete a document
- **Storage features**:
  - Auto-detects backend: S3 if `STORAGE_S3_BUCKET` env var set, otherwise local filesystem
  - Local storage default path: `./uploads` (configurable via `STORAGE_LOCAL_PATH`)
  - S3 storage key prefix: `documents/{project_id}/{document_id}_{filename}`
  - File validation: max 50MB, supported types (PDF, DOCX, TXT, PNG, JPEG, GIF, WebP)
  - MD5 checksum computed for uploads
- **Quality checks**: Passed ruff lint; mypy errors are in pre-existing files only
- **Learnings:**
  - Pattern: Document endpoints follow similar structure to phase endpoints but under `/documents` not `/phases`
  - Pattern: Abstract base class `StorageBackend` allows easy addition of new storage backends
  - Gotcha: Without a document metadata DB table, download/delete require filesystem glob to find files by document_id
  - Pattern: Use `time.monotonic()` for duration tracking, log slow operations (>1000ms)
---

## 2026-02-01 - client-onboarding-v2-c3y.113
- **What was implemented**: Verified frontend error logging already fully implemented
- **Files present** (no changes needed):
  - `frontend/src/components/ErrorBoundary.tsx` - React Error Boundary with component stack logging
  - `frontend/src/lib/errorReporting.ts` - Centralized error reporting with Sentry stub integration
  - `frontend/src/lib/globalErrorHandlers.ts` - Global window.onerror and onunhandledrejection handlers
  - `frontend/src/lib/api.ts` - API client with comprehensive error logging (endpoint, status, response body)
  - `frontend/src/lib/env.ts` - Environment config including VITE_SENTRY_DSN support
  - `frontend/src/main.tsx` - Initializes global handlers and error reporting before React mounts
  - `frontend/src/App.tsx` - Routes wrapped in ErrorBoundary components
- **Features available**:
  - ErrorBoundary class component with componentStack logging and retry button
  - `withErrorBoundary` HOC for wrapping components
  - Global handlers for uncaught errors and unhandled promise rejections
  - API client logs errors with endpoint, method, status, responseBody, userAction, component
  - Sentry integration point ready (just set VITE_SENTRY_DSN and uncomment Sentry.init)
  - Breadcrumb support for debugging API call traces
- **Quality checks**: Passed TypeScript typecheck and ESLint
- **Learnings:**
  - Pattern: Initialize global error handlers BEFORE React mounts in main.tsx
  - Pattern: Wrap each route in its own ErrorBoundary with componentName prop for better error context
  - Pattern: API client accepts `userAction` and `component` options for rich error context
  - Pattern: Use synthetic Error objects for non-Error throws/rejections to maintain consistent logging
---

