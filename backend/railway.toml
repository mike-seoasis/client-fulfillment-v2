# Railway Configuration for Client Fulfillment App V2
# Production-ready deployment configuration
#
# This configuration works for both staging and production environments.
# Environment-specific settings should be configured in Railway dashboard:
# - ENVIRONMENT: "staging" or "production"
# - LOG_LEVEL: "DEBUG" for staging, "INFO" for production
# - DEBUG: "true" for staging, "false" for production
#
# PostgreSQL and Redis addons set these automatically:
# - DATABASE_URL: PostgreSQL connection string
# - REDIS_URL: Redis connection string
#
# See RAILWAY_ENV.md for complete environment variable documentation.

[build]
# Use Python 3.11 runtime with Nixpacks
builder = "NIXPACKS"

[build.nixpacksPlan]
# Python version for Railway
nixPkgs = ["python311"]

[deploy]
# Health check configuration
# Railway pings this endpoint to verify deployment health
healthcheckPath = "/health"
healthcheckTimeout = 120

# Start command: run deploy script (migrations + validation) then start server
# Deploy script handles:
# - Environment variable validation with masked logging
# - Database connection verification
# - Migration execution with step-by-step logging
# - Post-migration data integrity validation
# - Rollback trigger logging on failure
# TEMP: test without deploy script
startCommand = "uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1 --log-level debug"

# Restart policy for resilience
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

# Number of instances (1 for staging, scale up for production via dashboard)
numReplicas = 1

[deploy.env]
# Default environment settings (override in Railway dashboard per environment)
LOG_FORMAT = "json"
